#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") <project-name> [py-ver] [extra-pkgs...]

Creates a folder <project-name> with a flake exposing a Python devshell.

Arguments:
  project-name    directory to create
  py-ver          python version, e.g. 3.11 (default: 3.11)
  extra-pkgs      extra python packages from nixpkgs pythonPackages (space-separated)

Example:
  make-py-devshell myproj 3.11 numpy pandas
EOF
  exit 1
}

if [ $# -lt 1 ]; then usage; fi

proj="$1"
shift || true
py_ver="${1:-3.11}"
if [ $# -ge 1 ]; then
  # if user supplied py_ver explicitly (pos 2), shift it out
  if [[ "$1" =~ ^[0-9]+\.[0-9]+$ ]]; then
    py_ver="$1"
    shift
  fi
fi

extra_py_pkgs=( "$@" )

if [ -d "$proj" ]; then
  echo "error: directory '$proj' already exists" >&2
  exit 1
fi

mkdir -p "$proj"
cd "$proj"

# write .envrc (direnv + hide diff + use flake)
cat > .envrc <<'EOF'
export DIRENV_HIDE_ENV_DIFF=1
use flake
EOF

# write README
cat > README.md <<EOF
# $proj (Python devshell)

Enter the shell with:

\`\`\`
nix develop .#python
\`\`\`

Enable flakes if needed: add to /etc/nix/nix.conf
\`experimental-features = nix-command flakes\`
EOF

# compute python attr name like python311 from 3.11
py_attr="python${py_ver//./}"

# make python package list for withPackages: ps.<pkg>
py_list=""
for p in "${extra_py_pkgs[@]}"; do
  safe="$(echo "$p" | sed 's/[^a-zA-Z0-9_.-]/_/g')"
  py_list="$py_list
          ps.$safe"
done

# generate flake.nix
cat > flake.nix <<EOF
{
  description = "Dev shell: python (${py_ver})";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixos-25.11";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils, ... }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = import nixpkgs { inherit system; };
        pythonAttr = pkgs.${py_attr};
        pythonEnv = pythonAttr.withPackages (ps: with ps; [
          pytest
          black
	  euporie
          mypy
          pip
          setuptools
          wheel
$py_list
        ]);
      in {
        devShells.default = pkgs.mkShell {
            name = "python-devshell";
            buildInputs = [
              pythonEnv
              pkgs.poetry
              pkgs.git
              pkgs.ripgrep
              pkgs.gdb
            ];
            shellHook = ''
              export VIRTUAL_ENV_DISABLE_PROMPT=1
              clear
              echo "ðŸ“¦ Python devshell active â€” python ${py_ver}"
              echo "Use: python, pip, pytest, black, euporie, mypy, poetry"
            '';
          };
      });
}
EOF

git init -q
git add -A
git commit -qm "init: python devshell (${py_ver})" || true

echo "Created Python devshell project '$proj'."
echo "cd $proj && direnv allow && nix develop .#python"

